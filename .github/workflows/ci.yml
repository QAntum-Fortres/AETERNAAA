name: AETERNA CI/CD

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

env:
    CARGO_TERM_COLOR: always

jobs:
    rust-check:
        name: Rust Quality Gate
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Install Rust Toolchain
              uses: dtolnay/rust-action@stable
              with:
                  components: clippy

            - name: Cache Cargo Dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: lwas_core

            - name: Compile Check
              run: cargo check --lib
              working-directory: ./lwas_core

            - name: Run Tests
              run: cargo test --lib
              working-directory: ./lwas_core

            - name: Clippy Linting
              run: cargo clippy --lib -- -D warnings
              working-directory: ./lwas_core

    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Install cargo-audit
              run: cargo install cargo-audit

            - name: Run Security Audit
              run: cargo audit
              working-directory: ./lwas_core

    frontend-build:
        name: Frontend Build Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: helios-ui/package-lock.json

            - name: Install Dependencies
              run: npm ci
              working-directory: ./helios-ui

            - name: Build Frontend
              run: npm run build
              working-directory: ./helios-ui

    deploy-backend:
        name: Deploy Backend (Railway)
        runs-on: ubuntu-latest
        needs: [rust-check, security-audit]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Deploy to Railway
              uses: bervProject/railway-deploy@main
              with:
                  railway_token: ${{ secrets.RAILWAY_TOKEN }}
                  service: aeterna-backend

    deploy-frontend:
        name: Deploy Frontend (Netlify)
        runs-on: ubuntu-latest
        needs: [frontend-build]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Dependencies
              run: npm ci
              working-directory: ./helios-ui

            - name: Build Frontend
              run: npm run build
              working-directory: ./helios-ui

            - name: Deploy to Netlify
              uses: nwtgck/actions-netlify@v2
              with:
                  publish-dir: ./helios-ui/dist
                  production-deploy: true
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
